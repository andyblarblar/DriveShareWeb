<!DOCTYPE html>

<header>
    <title>Listing Page</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css"
        integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="static/styles.css">
</header>

<body>
    <!-- Copy & Paste to Home, Listings, Reservations, etc (But not Login/Signup)-->
    <!-- Top Navbar -->
    <div id="header">
        <div id="nav-boxes" class="pure-g">
            <a class="pure-u-1-3 nav-box" id="assign-box" href="/">
                Home
            </a>
            <a class="pure-u-1-3 nav-box" id="assign-box" href="/searchlistings">
                Search
            </a>
            <a class="pure-u-1-3 nav-box" id="assign-box" href="/mylistings">
                My Listings
            </a>
            <a class="pure-u-1-3 nav-box" id="assign-box" href="/myreservations">
                My Reservations
            </a>
            <a class="pure-u-1-3 nav-box" id="assign-box">
                Balance: $<span id="balance"></span>
            </a>
        </div>
        <div id="logout">
            <a id="logout-icon-holder" href="/logout">
                <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
                    <path
                        d="M502.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-128-128c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L402.7 224 192 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l210.7 0-73.4 73.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l128-128zM160 96c17.7 0 32-14.3 32-32s-14.3-32-32-32L96 32C43 32 0 75 0 128L0 384c0 53 43 96 96 96l64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0c-17.7 0-32-14.3-32-32l0-256c0-17.7 14.3-32 32-32l64 0z" />
                </svg>
            </a>
        </div>
    </div>
    <!-- End Navbar -->

    <!-- Begin Page Content -->
    <p>Listing page</p>
    <style>
        .split-container {
            display: flex;
            align-items: flex-start;
            /* Updated: align items to flex-start */
            justify-content: center;
            height: 100vh;
            position: relative;
            /* Added: set position to relative */
        }

        .left-side,
        .right-side {
            flex: 1;
            text-align: center;
        }

        .left-side {
            border-right: 1px solid black;
            padding-right: 20px;
        }

        .search-Button {
            margin-top: 20px;
            /* Added: set margin-top to create space */
        }
    </style>

    <div>
        <h1 class="centered-text" style="text-align: center;">Listing Reviews</h1>
        <dl id="listingGrid" class="listingsContainer"></dl>
    </div>

</body>

<script>

    function createListingElement(listing) {
        let model = '';
        let year = '';
        let mileage = '';
        let location = '';
        let price = '';
        let dateRanges = '';
        let id = '';
        let owner = '';

        return {
            addModel: function (value) {
                model = value;
                return this;
            },
            addYear: function (value) {
                year = value;
                return this;
            },
            addMileage: function (value) {
                mileage = value;
                return this;
            },
            addLocation: function (value) {
                location = value;
                return this;
            },
            addPrice: function (value) {
                price = value;
                return this;
            },
            addDateRanges: function (value) {
                dateRanges = value;
                return this;
            },
            addId: function (value) {
                id = value;
                return this;
            },
            addOwner: function (value) {
                owner = value;
                return this;
            },
            build: function () {
                const listingElement = document.createElement('div');
                listingElement.classList.add('minimalistBlack'); // CSS for this at bottom of code

                const listingContent = document.createElement('div');
                listingContent.innerHTML = `
                    <table class="minimalistBlack">
                        <tr>
                            <td>Model</td><td>Year</td><td>Mileage</td><td>Location</td><td>Price per day</td><td>Start Date   -   End Date</td><td>ID</td><td>Owner</td>
                        </tr>
                        <tr>
                        <td class="model">${model}</td>
                        <td class="year">${year}</td>
                        <td class="mileage">${mileage}</td>
                        <td class="location">${location}</td>
                        <td class="price">$${price}</td>
                        <td class="dateRanges">${dateRanges}</td>
                        <td class="id">${id}</td>
                        <td class="owner">${owner}</td>                    
                    </tr>
                    </table>`;
                listingElement.appendChild(listingContent);
                return listingElement;
            }

        };
    }


    function showListings() {
        const params = new URLSearchParams(window.location.search)
        let listingID = params.get('listingID');
        
        fetch(`/listing/${listingID}`)
            .then(response => response.json())
            .then(data => {
                const listingsContainer = document.getElementById('listingGrid');
                listingsContainer.innerHTML = '';

                data.forEach(listing => {
                    const listingElement = createListingElement(listing)
                        .addModel(listing.model)
                        .addYear(listing.year)
                        .addMileage(listing.mileage)
                        .addLocation(listing.location)
                        .addPrice(listing.price)
                        .addDateRanges(listing.date_ranges)
                        .addId(listing.id)
                        .addOwner(listing.owner)
                        .build();

                    listingsContainer.appendChild(listingElement);
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }


    // Calls getReviews on page load
    window.onload = function () {
        getReviews();
    }


    // Gets Reviews to display
    async function getReviews() {
        const params = new URLSearchParams(window.location.search)
        let listingID = params.get('listingID');

        // GET reservations json for listing
        let response = await fetch(`/reservation/${listingID}`);
        let allReservations = await response.json();

        // Loop through list of reservations
        for (let i = 0; i < allReservations.length; i++) {
            let obj = allReservations[i];
            let reviewId = obj.id;

            // GET all reviews for specific reservation
            let response = await fetch(`/review/${reviewId}`)
            let review = await response.json();

            for (let j = 0; j < review.length; j++) {
                let obj2 = review[j]

                // Temp log review --->>>!!! Eventually should display reviews on page
                console.log(obj2.text, obj2.rating)
            }
        }
    }

</script>